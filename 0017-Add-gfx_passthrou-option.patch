From e7496e7eefe19c48406b2c3e8885888e4db26bdd Mon Sep 17 00:00:00 2001
From: Artur Puzio <cytadela8@users.noreply.github.com>
Date: Tue, 7 Apr 2020 22:10:32 +0200
Subject: [PATCH] Add gfx_passthrou option

---
 docs/schemas/domaincommon.rng |  5 +++++
 src/conf/domain_conf.c        | 12 +++++++++++-
 src/conf/domain_conf.h        |  1 +
 src/libxl/libxl_conf.c        |  2 ++
 4 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/docs/schemas/domaincommon.rng b/docs/schemas/domaincommon.rng
index 23cfd74c21..b245210089 100644
--- a/docs/schemas/domaincommon.rng
+++ b/docs/schemas/domaincommon.rng
@@ -5071,6 +5071,11 @@
   </define>
   <define name="devices">
     <element name="devices">
+      <optional>
+        <attribute name="gfx_passthru">
+          <ref name="virYesNo"/>
+        </attribute>
+      </optional>
       <interleave>
         <optional>
           <ref name="emulator"/>
diff --git a/src/conf/domain_conf.c b/src/conf/domain_conf.c
index e8f78ab327..6d67ce90bf 100644
--- a/src/conf/domain_conf.c
+++ b/src/conf/domain_conf.c
@@ -20959,6 +20959,13 @@ virDomainDefParseXML(xmlDocPtr xml,
     }
     def->emulator_cmdline = virXPathString("string(./devices/emulator/@cmdline)", ctxt);
 
+    def->gfx_passthru = false;
+    if ((tmp = virXPathString("string(./devices/@gfx_passthru)", ctxt)) != NULL) {
+        if (STREQ(permissive, "yes"))
+            def->gfx_passthru = true;
+        VIR_FREE(tmp);
+    }
+
     n = virXPathULong("string(./devices/emulator/@memory)",
                       ctxt,
                       &def->emulator_memory);
@@ -28942,7 +28949,10 @@ virDomainDefFormatInternalSetRootName(virDomainDefPtr def,
 
     virDomainPerfDefFormat(buf, &def->perf);
 
-    virBufferAddLit(buf, "<devices>\n");
+    virBufferAddLit(buf, "<devices");
+    if (def->gfx_passthru)
+        virBufferAddLit(buf, " gfx_passthru='yes'");
+    virBufferAddLit(buf, ">\n");
     virBufferAdjustIndent(buf, 2);
 
     if (def->emulator ||
diff --git a/src/conf/domain_conf.h b/src/conf/domain_conf.h
index abed8c966c..0ba7cb9d2e 100644
--- a/src/conf/domain_conf.h
+++ b/src/conf/domain_conf.h
@@ -2446,6 +2446,7 @@ struct _virDomainDef {
     virDomainEmulatorType emulator_type;
     char *emulator_cmdline;
     unsigned long emulator_memory;
+    bool gfx_passthru;
     /* Most {caps_,hyperv_,kvm_,}feature options utilize a virTristateSwitch
      * to handle support. A few assign specific data values to the option.
      * See virDomainDefFeaturesCheckABIStability() for details. */
diff --git a/src/libxl/libxl_conf.c b/src/libxl/libxl_conf.c
index 27de67d266..5a695223f8 100644
--- a/src/libxl/libxl_conf.c
+++ b/src/libxl/libxl_conf.c
@@ -681,6 +681,8 @@ libxlMakeDomBuildInfo(virDomainDefPtr def,
             return -1;
         }
 #endif
+        if (def->gfx_passthru)
+            libxl_defbool_set(b_info->u.hvm.gfx_passthru, 1);
     } else if (pvh) {
         b_info->cmdline = g_strdup(def->os.cmdline);
         b_info->kernel = g_strdup(def->os.kernel);
-- 
2.26.0

